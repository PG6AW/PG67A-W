import tkinter as tk
from tkinter import messagebox
import sqlite3
import datetime
import subprocess
import getpass
import ctypes


conn = sqlite3.connect("accounts.db")
cursor = conn.cursor()
cursor.execute("""CREATE TABLE IF NOT EXISTS register (
               id INTEGER PRIMARY KEY AUTOINCREMENT,
               name TEXT,
               gender TEXT,
               birth_year INTEGER,
               birth_month TEXT,
               birth_day INTEGER,
               email TEXT,
               username TEXT UNIQUE,
               password TEXT,
               event_by_admin TEXT,
               register_date TEXT
)
""")
conn.commit()

def login():
    conn = sqlite3.connect("accounts.db")
    cursor = conn.cursor()
    username = username_entry_2.get()
    password = password_entry_2.get()

    if username == "" or password == "":
        messagebox.showerror("Error", "Both fields must be filled in!")
        return
    try:
        cursor.execute("SELECT password FROM register WHERE username=?", (username,))
        correct_password = cursor.fetchone()
        if correct_password is None:
            correct_password = str(correct_password)
        else:
            correct_password = list(correct_password)
            for i in correct_password:
                i = str(i)
        try:
            if i == str(password):
                # username_entry_2.delete(0, tk.END)
                password_entry_2.delete(0, tk.END)
                confirm = messagebox.askyesno("Success", "You have been successfully authenticated!\n\n__EXIT THE AUTHENTICATOR AND OPEN THE LIBRARY REGISTRY APP?__")
                if confirm:

                    cursor.execute("SELECT name FROM register WHERE username=?", (username,))
                    name = cursor.fetchone()
                    if name is None:
                        name = str(name)
                    else:
                        name = list(name)
                        for j in name:
                            j = str(j)

                    cursor.execute("SELECT email FROM register WHERE username=?", (username,))
                    email = cursor.fetchone()
                    if email is None:
                        email = str(email)
                    else:
                        email = list(email)
                        for mail in email:
                            mail = str(mail)

                    conn = sqlite3.connect("accounts.db")
                    cursor = conn.cursor()
                    cursor.execute("""CREATE TABLE IF NOT EXISTS login_logs (
                                id INTEGER PRIMARY KEY AUTOINCREMENT,
                                name TEXT,
                                username TEXT,
                                email TEXT,
                                event_by_admin TEXT,
                                login_date TEXT
                    )
                    """)
                    conn.commit()
                    current_username = getpass.getuser()
                    event_by_admin = current_username
                    cursor.execute("INSERT INTO login_logs (name, username, email, event_by_admin, login_date) VALUES (?, ?, ?, ?, ?)", (j, username, mail, event_by_admin, datetime.datetime.now()))
                    conn.commit()
                    conn.close()

                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    
                    messagebox.showinfo("READ ON TO THE END!", "The window you are now being redirected to, is just a Legacy portion from our previous project 'LIBRARY MANAGEMENT SYSTEM V2.74' & solely aims to outline the fact for anyone using this project that they can modify it with ease and replace this with any other sorta tasks like a 'Banking App' or an 'Email Management App' or anything else.\n\nOur modern user-authenticator tkinter project is made with love to help anyone when it comes down to handling user security, user account management and some database works that may at first seem tough to pull off the whole management work manually & personally!, and to illustrate that this open-source project can facilitate in handling all such hassle and further remove the burden of user management chore.\n\nThis part of code has been commented in the main codebase just inside login.py python file which can be further customized depending upon your own piece or pieces of work!\n\nDON'T FORGET TO ALWAYS INCLUDE THE LICENSE AS YOU USE THIS PROJECT AND SUPPORT US ON GITHUB!\n\nGOOD LUCK:)")
                    subprocess.Popen(['python', 'Library_Registry/Registry.py']) #You can modify the address to which user will be redirected!

                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    ################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
                    
                    window.destroy()
                else:
                    return
            else:
                messagebox.showerror("Authetnication Error", "Wrong Credentials provided including the username and password!")
        except UnboundLocalError:
            messagebox.showerror("Invalid Username", "User doesn't exist in the local database!")
            conn.close()
            return
    except sqlite3.OperationalError:
        messagebox.showinfo("Fresh/Empty", "The database is fresh and empty!\nNobody has registered themselves yet!\n\nYou can be the first one though by firing the REGISTER button on the left hand side!")
        return

show_it = "no"
def show_entry_text():
    global show_it
    if show_it != "yes":
        password_entry_2.configure(show="")
        show_pass_button.configure(text="Hide", bg="#333333", fg="white")
        show_it = "yes"
    elif show_it == "yes":
        password_entry_2.configure(show="*")
        show_pass_button.configure(text="Show", bg="red", fg="yellow")
        show_it = "no"

def go_to_register():
    confirm = messagebox.askyesno("Confirmation", "Go to the register window?")
    if confirm:
        subprocess.Popen(['python', 'register.py'])
        conn.close()
        window.destroy()
    else:
        return

def exit_button():
    confirm = messagebox.askyesno("Confirmation", "SURE TO EXIT THE AUTHENTICATOR?")
    if confirm:
        conn.close()
        window.destroy()
        exit()
    else:
        return

lightness = "bright"
def dark_bright():
    global lightness
    if lightness == "bright":
        window.configure(bg="#333333")
        login_frame.configure(bg="#333333")
        hyphen_label.configure(bg="#333333")
        username_entry_2.configure(bg="lightblue")
        password_entry_2.configure(bg="#bbbbbb")
        caps_lock_label_left.configure(bg="#333333")
        caps_lock_label_right.configure(bg="#333333")
        brightness_button_left.configure(bg="orange", fg="darkgreen", text="Light ", width=3, font="arial 7 bold")
        brightness_button_right.configure(bg="orange", fg="darkgreen", text="Light ", width=3, font="arial 7 bold")
        brightness_button_left.place(relx=0.022, rely=0.95, anchor=tk.N)
        brightness_button_right.place(relx=0.975, rely=0.95, anchor=tk.N)
        lightness = "dark"
    elif lightness == "dark":
        window.configure(bg="green")
        login_frame.configure(bg="green")
        hyphen_label.configure(bg="green")
        username_entry_2.configure(bg="white")
        password_entry_2.configure(bg="#dddddd")
        caps_lock_label_left.configure(bg="green")
        caps_lock_label_right.configure(bg="green")
        brightness_button_left.configure(bg="#333333", fg="orange", text="Dark", width=3, font="arial 7 bold")
        brightness_button_right.configure(bg="#333333", fg="orange", text="Dark", width=3, font="arial 7 bold")
        brightness_button_left.place(relx=0.022, rely=0.95, anchor=tk.N)
        brightness_button_right.place(relx=0.975, rely=0.95, anchor=tk.N)
        lightness = "bright"

def check_caps_lock():
    keyboard_state = ctypes.windll.user32.GetKeyState(0x14)
    caps_lock_state = keyboard_state & 0x0001 != 0
    
    if caps_lock_state:
        caps_lock_label_left.configure(fg="red", text="CapsLock On!")
        caps_lock_label_right.configure(fg="red", text="CapsLock On!")
    else:
        caps_lock_label_left.configure(fg="green", text="")
        caps_lock_label_right.configure(fg="green", text="")
    window.after(1000, check_caps_lock)

window = tk.Tk()
window.configure(bg="green")
window.geometry("570x370")
window.resizable(False, False)
window.title("Login")

login_frame = tk.Frame(window)
login_frame.configure(bg="green")
login_frame.place(relx=0.5, rely=0.004, anchor=tk.N)

main_label_2 = tk.Label(login_frame, text="Login ", bg="orange", font="impact 18 italic")
username_label_2 = tk.Label(login_frame, text="Enter your Username: ", font="arial 15 bold", bg="yellow")
username_entry_2 = tk.Entry(login_frame, font="arial 18 italic", justify="center", width=40, fg="purple", relief="ridge")
password_label_2 = tk.Label(login_frame, text="Enter your Password: ", font="arial 15 bold", bg="yellow")
password_entry_2 = tk.Entry(login_frame, font="arial 18 italic", justify="center", width=40, fg="purple", relief="ridge", show="*", bg="#dddddd")
submit_button2 = tk.Button(window, text="Login! - >", command=login, font="arial 15 bold", bg="blue", fg="yellow", relief="raised")
quit_button = tk.Button(window, text="QUIT ", font="lotus 9 italic", bg="red", fg="darkblue", command=exit_button, relief="ridge")
go_to_register_button = tk.Button(window, text="REGISTER", command=go_to_register, font="arial 15 italic", bg="darkblue", fg="yellow", relief="ridge")
hyphen_label = tk.Label(window, text="|  |", font="arial 15 bold", bg="green", fg="orange")
show_pass_button = tk.Button(window, text="Show", command=show_entry_text, font="arial 8 bold", bg="red", fg="yellow", width=4, relief="groove")
show_pass_button.place(relx=0.92, rely=0.6, anchor=tk.N)

brightness_button_left = tk.Button(window, text="Dark", bg="#333333", fg="orange", font="arial 7 bold", width="3", relief="groove", command=dark_bright)
brightness_button_right = tk.Button(window, text="Dark", bg="#333333", fg="orange", font="arial 7 bold", width="3", relief="groove", command=dark_bright)
brightness_button_left.place(relx=0.022, rely=0.95, anchor=tk.N)
brightness_button_right.place(relx=0.975, rely=0.95, anchor=tk.N)

caps_lock_label_left = tk.Label(window, text="", bg="green", fg="green", font="arial 10 bold", height=1, width=11)
caps_lock_label_right = tk.Label(window, text="", bg="green", fg="green", font="arial 10 bold", height=1, width=11)
caps_lock_label_left.place(relx=0.18, rely=0.478, anchor=tk.N)
caps_lock_label_right.place(relx=0.82, rely=0.478, anchor=tk.N)
check_caps_lock()

main_label_2.pack(pady=18)
username_label_2.pack(pady=10)
username_entry_2.pack(pady=5)
password_label_2.pack(pady=10)
password_entry_2.pack(pady=5)
submit_button2.place(relx=0.647, rely=0.748, anchor=tk.N)
quit_button.place(relx=0.5, rely=0.91, anchor=tk.N)
go_to_register_button.place(relx=0.343, rely=0.748, anchor=tk.N)
hyphen_label.place(relx=0.5, rely=0.76, anchor=tk.N)

window.mainloop()
conn.close()